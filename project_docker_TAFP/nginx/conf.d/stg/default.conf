# ================================
# STG: Nginx ルーティング設定
# ================================
# 目的:
# - /      : Angular(SPA) を静的配信する（ビルド済みファイル）
# - /api/* : FastAPI へリバースプロキシする（模擬本番の「単一ドメイン」構成）
# - FastAPI は docs_url/openapi_url を /api 配下に揃えている前提
#   例: docs_url="/api/docs", openapi_url="/api/openapi.json"
#
# ※ SPA は直接URL叩き（/blogs/123等）をすると静的ファイルが見つからず404になりがち。
#    そのため try_files で index.html にフォールバックしてフロント側ルーティングを成立させる。

# --------------------------------
# upstream: API の実体（Docker ネットワーク内のサービス名）
# --------------------------------

upstream fastapi_upstream {
    # Docker Compose の service 名が "fastapi" で、コンテナ内の待受が 8000 の想定
    server fastapi:8000;
}
# メインサーバー設定
server {

    # stg は nginx が入口（ホストの 80 を受ける）
    listen 80;
    server_name localhost;
    # Angular の配信ディレクトリ
    # ※ dockerfiles/nginx/stgのDockerfile で dist を /usr/share/nginx/html 配下にコピーしている前提
    root /usr/share/nginx/html/tafp-angular;
    index index.html;
    # 送信ファイル上限（アップロード機能などがある場合の保険）
    client_max_body_size 20M;


    # -----------------------------
    # ルーティング API用: /api へのアクセスは FastAPI に転送
    # -----------------------------
    # /api (末尾スラなし) を叩かれた場合に /api/ へ統一するためリダイレクト（相対パス崩れ防止）
    location /api {
        return 301 /api/;
    }
    # /api/ 以下はすべて FastAPI へ
    location /api/ {
        # 重要:
        # - proxy_pass の末尾に "/" を付けないことで、URI をそのまま upstream に渡す。
        #   例: /api/docs -> upstream へ /api/docs のまま届く
        # - FastAPI 側が /api 配下で docs/openapi を提供する設計に揃っているため、この形が一番自然。
        proxy_pass http://fastapi_upstream;

        # --- 典型的なプロキシヘッダ ---
        # アプリ側でアクセス元IPやプロトコルを参照する場合に必要
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # WebSocket 等を使う可能性があるなら（必要なときだけ）
        # proxy_http_version 1.1;
        # proxy_set_header Upgrade $http_upgrade;
        # proxy_set_header Connection "upgrade";
    }

    # -----------------------------
    # ルーティング Frontend用 = SPA 静的配信
    # -----------------------------
    location / {
        # まずは実ファイルを探す（/assets/... 等）
        # 無ければ index.html を返してフロント側ルーティングに任せる
        try_files $uri $uri/ /index.html;
    }
}
